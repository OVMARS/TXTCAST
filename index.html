<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>TXTCAST - Specific TX Test (Forced Log)</title>
  <script src="https://unpkg.com/@solana/web3.js@1.75.1/lib/index.iife.min.js"></script>
  <link href="https://fonts.googleapis.com/css2?family=Fira+Code&display=swap" rel="stylesheet">
  <style>
    body { font-family: 'Fira Code', monospace; background: #111; color: #eee; padding: 20px; }
    pre { background: #222; padding: 15px; border-radius: 5px; white-space: pre-wrap; word-wrap: break-word; font-size: 0.9em;}
    .success { color: #0f0; }
    .error { color: #f00; }
    .warning { color: #ff0; }
    .info { color: #0af; }
  </style>
</head>
<body>
  <h1>TXTCAST - Specific Transaction Test (Forced Log of Suspected Memo Ix)</h1>
  <div id="output">Running test...</div>

  <script>
    const RPC_URL = "https://mainnet.helius-rpc.com/?api-key=34ea16bb-80b2-4e57-ad72-e94ecda7028a";
    const CORRECT_MEMO_PROGRAM_ID = "MemoSq4gqABAXKb96qnH8TysNcVtrp5GcC9YGN9qET9";

    const TRANSACTION_SIGNATURES_TO_TEST = [
      { sig: "4ihrUYY7FEpjwH8552nCMSeqiSMN8uBXxUtnT9ecEgp3epkQMjs75rx2nZvjP37YUDcdAsdQ8AZNbgUcJqDmgZfR", memoInstructionIndex: 2 }, // 3rd instruction
      { sig: "3qgqKLG3oKvXXVuCqKn7oVceArnX9aAdb3N1dAdLxBcEdiDbXZEVzQi3yMyhyNLtAZSZYLhLn3YAHQejSMBgsK7Y", memoInstructionIndex: 3 }  // 4th instruction
    ];

    const outputDiv = document.getElementById('output');

    function logObject(obj, sig, ixIndex, title = "Instruction Object") {
        try {
            const simpleObj = {
                programId: obj.programId ? obj.programId.toString() : undefined,
                program: obj.program,
                data: obj.data,
                parsed: obj.parsed
            };
            outputDiv.innerHTML += `<pre class="info">${title} for ${sig} (index ${ixIndex}):\n${JSON.stringify(simpleObj, null, 2)}</pre><br>`;
            console.log(`${title} for ${sig} (index ${ixIndex}):`, simpleObj);
        } catch (e) {
            outputDiv.innerHTML += `<span class="error">Error logging object: ${e.message}</span><br>`;
        }
    }

    async function testSpecificTransactions() {
      outputDiv.innerHTML = `Connecting to RPC: ${RPC_URL.split('?')[0]}...<br>`;
      outputDiv.innerHTML += `<span class="warning">Warning: Using Helius public example API key. This may be rate-limited or have restrictions. For reliable testing/use, get your own free key from helius.dev.</span><br>`;
      const connection = new solanaWeb3.Connection(RPC_URL, "confirmed");

      for (const txInfo of TRANSACTION_SIGNATURES_TO_TEST) {
        const sig = txInfo.sig;
        const expectedMemoIndex = txInfo.memoInstructionIndex;
        outputDiv.innerHTML += `<hr>Fetching transaction: ${sig}<br>`;
        try {
          const tx = await connection.getParsedTransaction(sig, {
            commitment: "confirmed",
            maxSupportedTransactionVersion: 0
          });

          if (!tx) {
            outputDiv.innerHTML += `<span class="error">Error: Transaction data not found or null for ${sig}.</span><br>`;
            continue;
          }
          outputDiv.innerHTML += `Transaction fetched. Slot: ${tx.slot}<br>`;
          if (!tx.transaction || !tx.transaction.message) {
            outputDiv.innerHTML += `<span class="error">Error: tx.transaction or tx.transaction.message is missing for ${sig}.</span><br>`;
            continue;
          }

          let memoFoundInTx = false;
          const instructionsToParse = [
            ...(tx.transaction.message.instructions || []),
            ...((tx.meta?.innerInstructions || []).flatMap(instrSet => instrSet.instructions) || [])
          ];
          outputDiv.innerHTML += `Total instructions to check (including inner): ${instructionsToParse.length}<br>`;

          for (let i = 0; i < instructionsToParse.length; i++) {
            const ix = instructionsToParse[i];
            outputDiv.innerHTML += `--- Checking instruction ${i + 1} ---<br>`;

            // Force log the object if it's the suspected memo instruction index
            if (i === expectedMemoIndex) {
                logObject(ix, sig, i, "Suspected Memo Instruction Object");
            } else {
                 outputDiv.innerHTML += `Program ID: ${ix.programId ? ix.programId.toString() : 'N/A (parsed by RPC)'}, Parsed Program Type: ${ix.program || 'N/A'}<br>`;
            }

            let memoData = "";
            if (ix.program === "spl-memo" && ix.parsed?.type === "memo" && ix.parsed?.info?.memo) {
              memoData = ix.parsed.info.memo;
              outputDiv.innerHTML += `Found "spl-memo" with parsed.type "memo" directly by RPC: "${memoData}"<br>`;
            } else if (!ix.program && ix.parsed?.type === "memo" && ix.parsed?.info?.memo) {
              memoData = ix.parsed.info.memo;
              outputDiv.innerHTML += `Found generic parsed.type "memo" directly by RPC: "${memoData}"<br>`;
            } else if (ix.programId?.toString() === CORRECT_MEMO_PROGRAM_ID && typeof ix.data === 'string') {
              outputDiv.innerHTML += `Is SPL Memo Program by ID. Raw data (base58): ${ix.data}<br>`;
              try {
                memoData = new TextDecoder().decode(solanaWeb3.utils.bytes.bs58.decode(ix.data));
                outputDiv.innerHTML += `Decoded SPL Memo data from raw: "${memoData}"<br>`;
              } catch (e) { outputDiv.innerHTML += `<span class="error">Error decoding SPL Memo raw data: ${e.message}</span><br>`; }
            } else if (i === expectedMemoIndex) { // Only if it's the suspected memo index and above failed
                 outputDiv.innerHTML += `Suspected memo instruction (index ${i}) did not match standard parsing methods.<br>`;
            }


            if (memoData && /^TXTCAST/i.test(memoData.trim())) {
              outputDiv.innerHTML += `<span class="success">SUCCESS: TXTCAST Found: "${memoData.trim()}"</span><br>`;
              memoFoundInTx = true;
              break;
            } else if (memoData) {
              outputDiv.innerHTML += `Found a memo, but it does not start with TXTCAST: "${memoData.trim()}"<br>`;
            }
          }
          if (!memoFoundInTx) {
            outputDiv.innerHTML += `<span class="error">No TXTCAST memo found in transaction ${sig}.</span><br>`;
          }
        } catch (error) { /* ... error handling ... */ }
      }
      outputDiv.innerHTML += "<hr>Test complete.<br>";
    }
    testSpecificTransactions();
  </script>
</body>
</html>
